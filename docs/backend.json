{
  "entities": {
    "UserAccount": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserAccount",
      "type": "object",
      "description": "Represents a user account within the BitHired application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user account."
        },
        "mobileNumber": {
          "type": "string",
          "description": "User's mobile phone number, used for login."
        },
        "virtualBalance": {
          "type": "number",
          "description": "The user's current virtual currency balance."
        }
      },
      "required": [
        "id",
        "mobileNumber"
      ]
    },
    "MiningMachine": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "MiningMachine",
      "type": "object",
      "description": "Represents a virtual mining machine available for hire.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the mining machine."
        },
        "name": {
          "type": "string",
          "description": "Name of the mining machine."
        },
        "miningRate": {
          "type": "number",
          "description": "The mining rate of the machine."
        }
      },
      "required": [
        "id",
        "name",
        "miningRate"
      ]
    },
    "RentalTransaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "RentalTransaction",
      "type": "object",
      "description": "Represents a transaction where a user hires a mining machine.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the rental transaction."
        },
        "userAccountId": {
          "type": "string",
          "description": "Reference to UserAccount. (Relationship: UserAccount 1:N RentalTransaction)"
        },
        "miningMachineId": {
          "type": "string",
          "description": "Reference to MiningMachine. (Relationship: MiningMachine 1:N RentalTransaction)"
        },
        "startDate": {
          "type": "string",
          "description": "The start date of the rental period.",
          "format": "date-time"
        },
        "endDate": {
          "type": "string",
          "description": "The end date of the rental period.",
          "format": "date-time"
        },
        "rentalCost": {
          "type": "number",
          "description": "The cost of renting the mining machine for the specified period."
        }
      },
      "required": [
        "id",
        "userAccountId",
        "miningMachineId",
        "startDate",
        "endDate",
        "rentalCost"
      ]
    },
    "MpesaTransaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "MpesaTransaction",
      "type": "object",
      "description": "Represents an MPESA transaction for topping up the virtual balance.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the MPESA transaction."
        },
        "userAccountId": {
          "type": "string",
          "description": "Reference to UserAccount. (Relationship: UserAccount 1:N MpesaTransaction)"
        },
        "mpesaCode": {
          "type": "string",
          "description": "The MPESA transaction code."
        },
        "amount": {
          "type": "number",
          "description": "The amount transferred via MPESA."
        },
        "transactionDate": {
          "type": "string",
          "description": "The date and time of the MPESA transaction.",
          "format": "date-time"
        },
        "systemGeneratedNumber": {
          "type": "string",
          "description": "The random number generated by the system for the user to send money to."
        }
      },
      "required": [
        "id",
        "userAccountId",
        "mpesaCode",
        "amount",
        "transactionDate",
        "systemGeneratedNumber"
      ]
    },
    "Deposit": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Deposit",
      "type": "object",
      "description": "Represents a deposit transaction made by a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the deposit."
        },
        "amount": {
          "type": "number",
          "description": "The amount deposited."
        },
        "date": {
          "type": "string",
          "format": "date-time",
          "description": "The date of the deposit."
        },
        "redeemCode": {
          "type": "string",
          "description": "The redeem code used for the deposit."
        },
        "status": {
          "type": "string",
          "enum": ["Completed"],
          "description": "The status of the deposit."
        }
      },
      "required": ["id", "amount", "date", "redeemCode", "status"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserAccount",
          "schema": {
            "$ref": "#/backend/entities/UserAccount"
          },
          "description": "Stores user account information. Uses path-based ownership for private user data.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user account, matching the Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/mining_machines/{miningMachineId}",
        "definition": {
          "entityName": "MiningMachine",
          "schema": {
            "$ref": "#/backend/entities/MiningMachine"
          },
          "description": "Stores information about available mining machines.",
          "params": [
            {
              "name": "miningMachineId",
              "description": "The unique identifier for the mining machine."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/rentals/{rentalId}",
        "definition": {
          "entityName": "RentalTransaction",
          "schema": {
            "$ref": "#/backend/entities/RentalTransaction"
          },
          "description": "Stores rental transaction data for a user. Includes denormalized 'userAccountId' to guarantee authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user account that created this rental transaction. (Relationship: UserAccount 1:N RentalTransaction)"
            },
            {
              "name": "rentalId",
              "description": "The unique identifier for the rental transaction."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/mpesa_transactions/{mpesaTransactionId}",
        "definition": {
          "entityName": "MpesaTransaction",
          "schema": {
            "$ref": "#/backend/entities/MpesaTransaction"
          },
          "description": "Stores MPESA transaction data for a user. Includes denormalized 'userAccountId' to guarantee authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user account that initiated this MPESA transaction. (Relationship: UserAccount 1:N MpesaTransaction)"
            },
            {
              "name": "mpesaTransactionId",
              "description": "The unique identifier for the MPESA transaction."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/deposits/{depositId}",
        "definition": {
          "entityName": "Deposit",
          "schema": {
            "$ref": "#/backend/entities/Deposit"
          },
          "description": "Stores deposit transaction data for a user.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user account that made this deposit."
            },
            {
              "name": "depositId",
              "description": "The unique identifier for the deposit transaction."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to ensure security, scalability, and ease of debugging, following the principles of Authorization Independence, Clarity of Intent, DBAC, and QAPs. Authorization independence is achieved through denormalization. Specifically, the `RentalTransaction` and `MpesaTransaction` collections include the `userAccountId`, which allows for direct rule validation based on `request.auth.uid` without needing to `get()` data from the `/users/{userId}` document. The structure also uses path-based ownership for private user data. Segregation of data is maintained by storing user accounts in a dedicated collection, mining machines in another, and rental transactions in paths dependent on the User. This approach ensures that all documents within a collection share the same security requirements, preventing the mixing of data with varying access needs. User-owned data uses hierarchical paths (`/users/{userId}/rentals/{rentalId}`) for clarity and security."
  }
}
